<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡å¼·å‹¢è‚¡ç¯©é¸å™¨ | Taiwan Stock Screener</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ range(1, 9999) | random }}">
    <script src="{{ url_for('static', filename='lightweight-charts.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='search_charts.js') }}?v={{ range(1, 9999) | random }}"></script>
    <script>
        // Check if library loaded
        window.addEventListener('load', function () {
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts library failed to load!');
                alert('åœ–è¡¨å‡½å¼åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–åˆ·æ–°é é¢ã€‚');
            }
        });
    </script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="flex-grow: 1;">
                    <h1>ğŸ”¥ å°è‚¡å¼·å‹¢è‚¡ç¯©é¸å™¨</h1>
                    <p class="subtitle">Taiwan Stock Screener - Outperforming the Market</p>
                </div>
                <button onclick="refreshIndices()" class="tab-button"
                    style="background: #fff; color: #1a237e; border: 1px solid #1a237e; padding: 10px 18px; font-size: 0.9em; height: fit-content; margin-top: 10px;">
                    ğŸ”„ æ‰‹å‹•æ›´æ–°å¤§ç›¤
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tab-navigation">
            <button class="tab-button active" onclick="switchTab('outperformers')">
                ğŸ† å„ªæ–¼å¤§ç›¤
            </button>
            <button class="tab-button" onclick="switchTab('listed-ranking')">
                ğŸ“Š ä¸Šå¸‚æ’å
            </button>
            <button class="tab-button" onclick="switchTab('otc-ranking')">
                ğŸ“ˆ ä¸Šæ«ƒæ’å
            </button>
            <button class="tab-button" onclick="switchTab('strong-stocks')">
                ğŸ’ª å¼·å‹¢é¸è‚¡
            </button>
            <button class="tab-button" onclick="switchTab('smart-picks')">
                ğŸ¤– æ™ºæ…§æ¨è–¦
            </button>
            <button class="tab-button" onclick="switchTab('search')">
                ğŸ” è‚¡ç¥¨æŸ¥è©¢
            </button>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel" id="filter-panel">
            <h2>ğŸ“Š ç¯©é¸æ¢ä»¶ | Filter Criteria</h2>

            <div class="filter-group">
                <label for="min-price-input">
                    ğŸ’° æœ€ä½è‚¡åƒ¹ | Min Price (TWD)
                </label>
                <input type="number" id="min-price-input" min="0" max="10000" value="50" step="1">
            </div>

            <div class="filter-group">
                <label for="max-price-input">
                    ğŸ’° æœ€é«˜è‚¡åƒ¹ | Max Price (TWD)
                </label>
                <input type="number" id="max-price-input" min="0" max="10000" value="200" step="1">
            </div>

            <div class="filter-group">
                <label for="market-cap-input">
                    ğŸ“ˆ æœ€å°å¸‚å€¼ | Min Market Cap (å„„ TWD)
                </label>
                <input type="number" id="market-cap-input" min="0" max="100000" value="100" step="10">
                <div class="filter-checkbox">
                    <label>
                        <input type="checkbox" id="enable-market-cap" checked>
                        å•Ÿç”¨å¸‚å€¼ç¯©é¸ | Enable Market Cap Filter
                    </label>
                </div>
            </div>

            <div class="filter-group">
                <label for="min-volume-input">
                    ğŸ“Š æœ€ä½æˆäº¤é‡ | Min Volume (å¼µ / 1000 shares)
                </label>
                <input type="number" id="min-volume-input" min="0" max="1000000" value="1000" step="100">
            </div>

            <div class="filter-group">
                <div class="filter-checkbox">
                    <label>
                        <input type="checkbox" id="gap-up-only">
                        åƒ…é¡¯ç¤ºé–‹é«˜ (Gap Up - é–‹ç›¤ > æ˜¨æ”¶)
                    </label>
                </div>
            </div>

            <button class="filter-button" id="filter-btn" onclick="filterStocks()">
                ğŸ” ç¯©é¸è‚¡ç¥¨ | Filter Stocks
            </button>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨åˆ†æè‚¡ç¥¨æ•¸æ“š...</p>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="error-message" style="display: none;"></div>

        <!-- Market Indices -->
        <div class="indices-panel" id="indices-panel" style="display: none;">
            <div class="index-card">
                <div class="index-name">ğŸ“Š åŠ æ¬ŠæŒ‡æ•¸ TAIEX</div>
                <div class="index-value" id="taiex-value">--</div>
                <div class="index-change" id="taiex-change">--%</div>
            </div>
            <div class="index-card">
                <div class="index-name">ğŸ“ˆ ä¸Šæ«ƒæŒ‡æ•¸ OTC</div>
                <div class="index-value" id="otc-value">--</div>
                <div class="index-change" id="otc-change">--%</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">åˆ†æç¸½æ•¸</span>
                <span class="stat-value" id="total-analyzed">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ç¬¦åˆé–€æª»</span>
                <span class="stat-value" id="total-filtered">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ä¸Šå¸‚å„ªæ–¼å¤§ç›¤</span>
                <span class="stat-value" id="listed-outperformers">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ä¸Šæ«ƒå„ªæ–¼å¤§ç›¤</span>
                <span class="stat-value" id="otc-outperformers">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æœ€å¾Œæ›´æ–°</span>
                <span class="stat-value" id="timestamp">--:--:--</span>
            </div>
        </div>

        <!-- Filter Funnel Description (Visible on Results) -->
        <div id="filter-funnel"
            style="display:none; background:#f0f4f8; padding:12px; border-radius:8px; margin-bottom:15px; border-left:4px solid #1a237e; font-size:0.9em;">
            <div style="font-weight:bold; color:#1a237e; margin-bottom:5px;">ğŸ” åš´æ ¼é¸è‚¡æ¼æ–— (Strict Selection Funnel)</div>
            <div id="funnel-text" style="color:#555;">
                å…¨éƒ¨è‚¡ç¥¨ &rarr; <b>å„ªæ–¼å¤§ç›¤ (Alpha&gt;0)</b> &rarr; <b>å¼·å‹¢è‚¡ (ç«™ç©©é«˜é»)</b> &rarr; <b>æ™ºæ…§æ¨è–¦ (æŠ€è¡“æŒ‡æ¨™)</b>
            </div>
        </div>

        <!-- Stock Search Panel -->
        <div class="search-panel" id="search-panel" style="display: none;">
            <h2>ğŸ” è‚¡ç¥¨æŸ¥è©¢ | Stock Search</h2>
            <div class="search-input-group">
                <input type="text" id="stock-search-input" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨± (ä¾‹å¦‚: 2330 æˆ– å°ç©é›»)" />
                <button class="search-button" onclick="searchStock()">æœå°‹</button>
            </div>
            <div id="search-results"></div>
        </div>

        <!-- å¼·å‹¢é¸è‚¡ Panel -->
        <div id="strong-stocks-panel" style="display: none;">
            <div
                style="background: linear-gradient(135deg,#1a237e,#283593); color:white; border-radius:12px; padding:20px; margin-bottom:20px;">
                <h2 style="margin:0 0 6px 0; font-size:1.3em;">ğŸ’ª å¼·å‹¢é¸è‚¡</h2>
                <p style="margin:0; font-size:0.9em; opacity:0.85;">
                    ä»¥ã€Œå„ªæ–¼å¤§ç›¤ + ç¯©é¸æ¢ä»¶ã€ç‚ºåŸºç¤ï¼Œå†ç–ŠåŠ æŠ€è¡“åˆ†ææ¢ä»¶ï¼ŒæŒ‘å‡ºç•¶æ—¥æœ€å¼·å‹¢çš„è‚¡ç¥¨
                </p>
            </div>
            <!-- æ¢ä»¶èªªæ˜ -->
            <div
                style="background:#f3f4ff; border:1px solid #c5cae9; border-radius:8px; padding:14px; margin-bottom:18px; font-size:0.88em; line-height:1.8;">
                <strong>ğŸ“‹ å·²å•Ÿç”¨æ¢ä»¶ï¼ˆAND é—œä¿‚ï¼Œå…¨éƒ¨éœ€ç¬¦åˆï¼‰ï¼š</strong><br>
                <span id="strong-conditions-list">
                    âœ… å„ªæ–¼å¤§ç›¤ï¼ˆå€‹è‚¡æ¼²å¹… &gt; æŒ‡æ•¸æ¼²å¹…ï¼‰<br>
                    âœ… å‰µ 5 æ—¥æ–°é«˜ï¼ˆä»Šæ—¥æ”¶ç›¤ â‰¥ å‰ 5 æ—¥æœ€é«˜æ”¶ç›¤ï¼‰
                </span>
            </div>
            <div style="text-align:center; margin-bottom:20px;">
                <button class="filter-button" onclick="getStrongStocks()"
                    style="background:linear-gradient(135deg,#1a237e,#3949ab); font-size:1em; padding:12px 32px;">
                    ğŸš€ é–‹å§‹ç¯©é¸å¼·å‹¢è‚¡
                </button>
            </div>
            <div id="strong-stocks-loading" style="display:none; text-align:center; padding:30px;">
                <div class="spinner" style="border-top-color:#1a237e; margin:0 auto 15px auto;"></div>
                <p style="color:#1a237e;">æ­£åœ¨æ‰¹æ¬¡ä¸‹è¼‰ K ç·šä¸¦åˆ†ææŠ€è¡“æŒ‡æ¨™...</p>
                <p style="font-size:0.85em; color:#999;">é€šå¸¸éœ€è¦ 10-30 ç§’</p>
            </div>
            <div id="strong-stocks-results"></div>
        </div>

        <!-- Smart Picks Panel -->
        <div class="smart-picks-panel" id="smart-picks-panel" style="display: none;">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #2e7d32;">ğŸ¤– AI æ™ºæ…§é¸è‚¡æ¨è–¦</h2>
                <p style="color: #666;">åŸºæ–¼å‹•èƒ½ã€å‡ç·šæ’åˆ—èˆ‡ RSI æŒ‡æ¨™çš„ç¶œåˆåˆ†æ</p>
                <div
                    style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 0.9em; text-align: left;">
                    <strong>ğŸ¯ ç¯©é¸ç­–ç•¥ï¼š</strong><br>
                    1. <strong>å¤šé ­æ’åˆ—</strong>ï¼šè‚¡åƒ¹ > MA5 > MA20 (çŸ­ä¸­é•·æœŸè¶¨å‹¢å‘ä¸Š)<br>
                    2. <strong>RSI å¼·å‹¢</strong>ï¼šRSI ä½æ–¼ 55-80 ä¹‹é–“ (å¼·å‹¢ä½†ä¸è‡³æ–¼éç†±)<br>
                    3. <strong>å‹•èƒ½çˆ†ç™¼</strong>ï¼šæˆäº¤é‡æ”¾å¤§ä¸”ç•¶æ—¥æ¼²å¹…å„ªæ–¼å¤§ç›¤
                </div>
                <button class="filter-button" onclick="getSmartRecommendations()"
                    style="background: #2e7d32; margin-top: 10px;">
                    ğŸš€ é–‹å§‹åˆ†æèˆ‡æ¨è–¦
                </button>
            </div>
            <div id="smart-picks-loading" style="display: none; text-align: center; padding: 30px;">
                <div class="spinner" style="border-top-color: #2e7d32; margin: 0 auto 15px auto;"></div>
                <p style="color: #2e7d32;">æ­£åœ¨é€²è¡Œæ·±åº¦æŠ€è¡“åˆ†æ...</p>
                <p style="font-size: 0.85em; color: #999;">å¯èƒ½éœ€è¦ 15-30 ç§’ä¾†åˆ†ææ­·å²æ•¸æ“š</p>
            </div>
            <div id="smart-picks-results"></div>
        </div>

        <!-- Results -->
        <div class="results" id="results"></div>
    </div>

    <script>
        // Enable/disable market cap filter controls
        const enableMarketCapCheckbox = document.getElementById('enable-market-cap');
        const marketCapInput = document.getElementById('market-cap-input');

        enableMarketCapCheckbox.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            marketCapInput.disabled = !enabled;
            marketCapInput.style.opacity = enabled ? '1' : '0.5';
        });

        async function filterStocks() {
            const minPrice = parseFloat(document.getElementById('min-price-input').value);
            const maxPrice = parseFloat(document.getElementById('max-price-input').value);
            const minMarketCap = parseFloat(document.getElementById('market-cap-input').value);
            const enableMarketCap = document.getElementById('enable-market-cap').checked;
            const gapUpOnly = document.getElementById('gap-up-only').checked;

            // Validation
            if (minPrice >= maxPrice) {
                showError('æœ€é«˜è‚¡åƒ¹å¿…é ˆå¤§æ–¼æœ€ä½è‚¡åƒ¹');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('indices-panel').style.display = 'none';
            document.getElementById('filter-btn').disabled = true;

            try {
                const response = await fetch('/api/screen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        min_price: minPrice,
                        max_price: maxPrice,
                        min_market_cap: enableMarketCap ? minMarketCap : 0,
                        enable_market_cap: enableMarketCap,
                        min_volume: parseFloat(document.getElementById('min-volume-input').value),
                        gap_up_only: gapUpOnly
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ç¯©é¸å¤±æ•—');
                }

                displayResults(data);
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('filter-btn').disabled = false;
            }
        }

        let currentData = null;
        let currentTab = 'outperformers';

        function switchTab(tabName) {
            currentTab = tabName;

            // Update button states
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Redisplay results with current tab
            if (currentData) {
                displayResults(currentData);
            }
        }

        function displayResults(data) {
            currentData = data;
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('stats');
            const indicesPanel = document.getElementById('indices-panel');

            // Display indices
            if (data.indices) {
                const taiex = data.indices.taiex;
                const otc = data.indices.otc;

                document.getElementById('taiex-value').textContent = taiex.value.toFixed(2);
                document.getElementById('otc-value').textContent = otc.value.toFixed(2);

                const taiexChangeEl = document.getElementById('taiex-change');
                const otcChangeEl = document.getElementById('otc-change');

                taiexChangeEl.textContent = (taiex.change_pct >= 0 ? '+' : '') + taiex.change_pct.toFixed(2) + '%';
                taiexChangeEl.className = 'index-change ' + (taiex.change_pct >= 0 ? 'positive' : 'negative');

                otcChangeEl.textContent = (otc.change_pct >= 0 ? '+' : '') + otc.change_pct.toFixed(2) + '%';
                otcChangeEl.className = 'index-change ' + (otc.change_pct >= 0 ? 'positive' : 'negative');

                indicesPanel.style.display = 'flex';
            }

            // Update stats
            document.getElementById('total-analyzed').textContent = data.stats.total_analyzed;
            document.getElementById('total-filtered').textContent = data.stats.total_filtered;
            document.getElementById('listed-outperformers').textContent = data.stats.listed_outperformers;
            document.getElementById('otc-outperformers').textContent = data.stats.otc_outperformers;
            document.getElementById('timestamp').textContent = data.timestamp;
            statsDiv.style.display = 'flex';

            // Update funnel info
            const funnel = document.getElementById('filter-funnel');
            const funnelText = document.getElementById('funnel-text');
            funnel.style.display = 'block';

            if (currentTab === 'outperformers') {
                funnelText.innerHTML = 'å…¨éƒ¨è‚¡ç¥¨ &rarr; <b style="color:#c62828;">å„ªæ–¼å¤§ç›¤ (Alpha > 0)</b> &rarr; å¼·å‹¢è‚¡ &rarr; æ™ºæ…§æ¨è–¦';
            } else if (currentTab === 'strong-stocks') {
                funnelText.innerHTML = 'å…¨éƒ¨è‚¡ç¥¨ &rarr; å„ªæ–¼å¤§ç›¤ &rarr; <b style="color:#c62828;">å¼·å‹¢è‚¡ (ç«™ç©©å¯¦é«”é«˜é»)</b> &rarr; æ™ºæ…§æ¨è–¦';
            } else if (currentTab === 'smart-picks' || currentTab === 'ai-scan') {
                funnelText.innerHTML = 'å…¨éƒ¨è‚¡ç¥¨ &rarr; å„ªæ–¼å¤§ç›¤ &rarr; å¼·å‹¢è‚¡ &rarr; <b style="color:#c62828;">æ™ºæ…§æ¨è–¦ (æŒ‡æ¨™å…¨å¤šé ­)</b>';
            } else {
                funnel.style.display = 'none';
            }

            // Show tab navigation
            const tabNavigation = document.getElementById('tab-navigation');
            tabNavigation.style.display = 'flex';

            // Clear results
            resultsDiv.innerHTML = '';

            // Display based on current tab
            if (currentTab === 'outperformers') {
                displayOutperformers(resultsDiv, data);
            } else if (currentTab === 'listed-ranking') {
                displayRanking(resultsDiv, data.listed_all, 'ä¸Šå¸‚è‚¡ç¥¨æ’å', data.indices.taiex.change_pct);
            } else if (currentTab === 'otc-ranking') {
                displayRanking(resultsDiv, data.otc_all, 'ä¸Šæ«ƒè‚¡ç¥¨æ’å', data.indices.otc.change_pct);
            }
        }

        function displayOutperformers(resultsDiv, data) {
            // Display listed stocks table
            if (data.listed_stocks && data.listed_stocks.length > 0) {
                const listedSection = document.createElement('div');
                listedSection.className = 'stock-section';
                listedSection.innerHTML = '<h2>ğŸ† ä¸Šå¸‚å¼·å‹¢è‚¡ (å„ªæ–¼åŠ æ¬ŠæŒ‡æ•¸)</h2>';

                const table = createStockTable(data.listed_stocks, data.indices.taiex.change_pct);
                listedSection.appendChild(table);
                resultsDiv.appendChild(listedSection);
            }

            // Display OTC stocks table
            if (data.otc_stocks && data.otc_stocks.length > 0) {
                const otcSection = document.createElement('div');
                otcSection.className = 'stock-section';
                otcSection.innerHTML = '<h2>ğŸ† ä¸Šæ«ƒå¼·å‹¢è‚¡ (å„ªæ–¼ä¸Šæ«ƒæŒ‡æ•¸)</h2>';

                const table = createStockTable(data.otc_stocks, data.indices.otc.change_pct);
                otcSection.appendChild(table);
                resultsDiv.appendChild(otcSection);
            }

            // No results
            if ((!data.listed_stocks || data.listed_stocks.length === 0) &&
                (!data.otc_stocks || data.otc_stocks.length === 0)) {
                resultsDiv.innerHTML = '<div class="no-results">âŒ æ²’æœ‰å„ªæ–¼å¤§ç›¤çš„è‚¡ç¥¨</div>';
            }
        }

        function displayRanking(resultsDiv, stocks, title, indexChange) {
            if (!stocks || stocks.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">âŒ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</div>';
                return;
            }

            const section = document.createElement('div');
            section.className = 'stock-section';
            section.innerHTML = `<h2>ğŸ“Š ${title}</h2>`;

            const table = createStockTable(stocks, indexChange, true);
            section.appendChild(table);
            resultsDiv.appendChild(section);
        }

        function createStockTable(stocks, indexChange, showRanking = false) {
            const table = document.createElement('table');
            table.className = 'stock-table';

            // Table header
            const headerHtml = showRanking
                ? `<thead><tr><th>æ’å</th><th>ä»£è™Ÿ</th><th>å…¬å¸åç¨±</th><th>æ¼²è·Œå¹…åº¦</th></tr></thead>`
                : `<thead><tr><th>ä»£è™Ÿ</th><th>å…¬å¸åç¨±</th><th>æ¼²è·Œå¹…åº¦</th></tr></thead>`;

            table.innerHTML = headerHtml + '<tbody id="stock-tbody"></tbody>';

            const tbody = table.querySelector('#stock-tbody');

            stocks.forEach((stock, index) => {
                const row = document.createElement('tr');
                row.className = 'stock-row';
                row.onclick = () => toggleStockDetails(row, stock, indexChange);

                const changeClass = stock.daily_change_pct >= 0 ? 'positive' : 'negative';
                const changeSymbol = stock.daily_change_pct >= 0 ? '+' : '';

                const rankingCell = showRanking
                    ? `<td class="stock-rank">${index + 1}</td>`
                    : '';

                row.innerHTML = `
                    ${rankingCell}
                    <td class="stock-code">${stock.symbol}</td>
                    <td class="stock-name">${stock.name}</td>
                    <td class="stock-change ${changeClass}">${changeSymbol}${stock.daily_change_pct.toFixed(2)}%</td>
                `;

                tbody.appendChild(row);
            });

            return table;
        }

        function toggleStockDetails(row, stock, indexChange) {
            const existingDetails = row.nextElementSibling;

            // If details already shown, hide them
            if (existingDetails && existingDetails.classList.contains('stock-details-row')) {
                existingDetails.remove();
                row.classList.remove('expanded');
                return;
            }

            // Create details row
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'stock-details-row';

            const outperformance = stock.daily_change_pct - indexChange;
            const changeClass = stock.daily_change_pct >= 0 ? 'positive' : 'negative';
            const changeSymbol = stock.daily_change_pct >= 0 ? '+' : '';

            detailsRow.innerHTML = `
                <td colspan="3">
                    <div class="stock-details-content">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">ç¾åƒ¹</span>
                                <span class="detail-value">${stock.current_price.toFixed(2)} TWD</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ¼²è·Œå¹…</span>
                                <span class="detail-value ${changeClass}">${changeSymbol}${stock.daily_change_pct.toFixed(2)}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">å„ªæ–¼å¤§ç›¤</span>
                                <span class="detail-value outperformance">+${outperformance.toFixed(2)}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æˆäº¤é‡</span>
                                <span class="detail-value">${stock.volume.toLocaleString()} è‚¡</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">å¸‚å€¼</span>
                                <span class="detail-value">${(stock.market_cap / 1e8).toFixed(2)} å„„</span>
                            </div>
                        </div>
                    </div>
                </td>
            `;

            row.classList.add('expanded');
            row.after(detailsRow);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
        }

        // Stock search functionality
        async function searchStock() {
            const query = document.getElementById('stock-search-input').value.trim();
            const searchResults = document.getElementById('search-results');

            if (!query) {
                searchResults.innerHTML = '<div class="no-results">âŒ è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±</div>';
                return;
            }

            searchResults.innerHTML = '<div style="text-align: center; padding: 20px;">ğŸ” æœå°‹ä¸­...</div>';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'æœå°‹å¤±æ•—');
                }

                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = `<div class="no-results">âŒ ${error.message}</div>`;
            }
        }

        // displaySearchResults, drawCandlestickChart, drawVolumeChart 
        // are now loaded from search_charts.js

        // Update switchTab to handle search
        // Update switchTab to handle search, smart picks, and filter visibility
        const originalSwitchTab = switchTab;
        switchTab = function (tabName) {
            currentTab = tabName;

            // Update button states
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Find the button that was clicked or corresponds to the tabName
            const targetBtn = document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }

            // Handle Filter Panel visibility
            const filterPanel = document.getElementById('filter-panel');
            const indicesPanel = document.getElementById('indices-panel');
            const statsDiv = document.getElementById('stats');
            const resultsDiv = document.getElementById('results');
            const smartPicksPanel = document.getElementById('smart-picks-panel');
            const strongStocksPanel = document.getElementById('strong-stocks-panel');
            const searchPanel = document.getElementById('search-panel');

            // Reset all panels
            filterPanel.style.display = 'none';
            resultsDiv.style.display = 'none';
            smartPicksPanel.style.display = 'none';
            strongStocksPanel.style.display = 'none';
            searchPanel.style.display = 'none';

            if (tabName === 'outperformers') {
                filterPanel.style.display = 'block';
                resultsDiv.style.display = 'block';
                if (currentData) {
                    indicesPanel.style.display = 'flex';
                    statsDiv.style.display = 'flex';
                    displayResults(currentData);
                }
            } else if (tabName === 'listed-ranking' || tabName === 'otc-ranking') {
                resultsDiv.style.display = 'block';
                // Show indices/stats for context
                if (currentData) {
                    indicesPanel.style.display = 'flex';
                    statsDiv.style.display = 'flex';
                    displayResults(currentData);
                }
            } else if (tabName === 'strong-stocks') {
                strongStocksPanel.style.display = 'block';
                indicesPanel.style.display = 'none';
                statsDiv.style.display = 'none';
            } else if (tabName === 'smart-picks') {
                smartPicksPanel.style.display = 'block';
                // Hide context panels to focus on smart picks
                indicesPanel.style.display = 'none';
                statsDiv.style.display = 'none';
            } else if (tabName === 'search') {
                searchPanel.style.display = 'block';
                indicesPanel.style.display = 'none';
                statsDiv.style.display = 'none';
            }
        };

        // Smart Recommendation Logic
        async function getSmartRecommendations() {
            const loading = document.getElementById('smart-picks-loading');
            const resultsDiv = document.getElementById('smart-picks-results');
            const btn = document.querySelector('.smart-picks-panel button');

            // è®€å–ç•¶å‰ç¯©é¸å™¨åƒæ•¸
            const minPrice = document.getElementById('min-price-input').value;
            const maxPrice = document.getElementById('max-price-input').value;
            const minVolume = document.getElementById('min-volume-input').value;

            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            btn.disabled = true;
            btn.style.opacity = '0.7';

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        min_price: minPrice,
                        max_price: maxPrice,
                        min_volume: minVolume
                    })
                });
                const data = await response.json();

                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    let html = `<div style="overflow-x:auto; margin-top:20px;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.9em; background:white; border-radius:8px; overflow:hidden;">
                            <thead>
                                <tr style="background:#f5f5f5; border-bottom:2px solid #ddd;">
                                    <th style="padding:12px 10px; text-align:left;">ä»£ç¢¼/åç¨±</th>
                                    <th style="padding:12px 10px; text-align:right;">ç¾åƒ¹</th>
                                    <th style="padding:12px 10px; text-align:right;">æ¼²è·Œ</th>
                                    <th style="padding:12px 10px; text-align:right; color:#1a237e;">å„ªæ–¼å¤§ç›¤</th>
                                    <th style="padding:12px 10px; text-align:left;">AI æ¨è–¦åŸå› </th>
                                </tr>
                            </thead>
                            <tbody>`;

                    data.recommendations.forEach(s => {
                        const chgColor = s.change_pct >= 0 ? '#c62828' : '#00695c';
                        const alphaColor = (s.alpha || 0) >= 0 ? '#1a237e' : '#555';
                        const tags = s.reasons.map(r =>
                            `<span style="display:inline-block; background:#e8f5e9; color:#2e7d32; padding:2px 8px; border-radius:4px; font-size:0.82em; margin:2px; border:1px solid #c8e6c9;">${r}</span>`
                        ).join('');

                        html += `<tr style="border-bottom:1px solid #eee;">
                            <td style="padding:12px 10px;">
                                <div style="font-weight:bold; color:#1565c0; font-size:1.1em;">${s.code}</div>
                                <div style="font-size:0.85em; color:#666;">${s.name}</div>
                            </td>
                            <td style="padding:12px 10px; text-align:right; font-weight:bold;">${s.price}</td>
                            <td style="padding:12px 10px; text-align:right; color:${chgColor}; font-weight:bold;">${s.change_pct}%</td>
                            <td style="padding:12px 10px; text-align:right; color:${alphaColor}; font-weight:bold;">${s.alpha > 0 ? '+' : ''}${s.alpha}%</td>
                            <td style="padding:12px 10px;">${tags}</td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">ğŸ˜• ç›®å‰æ²’æœ‰ç¬¦åˆ AI æ·±åº¦æƒææ¨™æº–çš„è‚¡ç¥¨ï¼Œå»ºè­°èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</div>';
                }
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error-message" style="display:block">âŒ è¼‰å…¥å¤±æ•—: ${err.message}</div>`;
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // â”€â”€ å¼·å‹¢é¸è‚¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function getStrongStocks() {
            const loading = document.getElementById('strong-stocks-loading');
            const resultsDiv = document.getElementById('strong-stocks-results');
            const btn = document.querySelector('#strong-stocks-panel button');

            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            btn.disabled = true;
            btn.style.opacity = '0.6';

            // å–å¾—ç›®å‰ç¯©é¸é¢æ¿çš„åƒæ•¸å€¼
            const payload = {
                min_price: parseFloat(document.getElementById('min-price-input').value),
                max_price: parseFloat(document.getElementById('max-price-input').value),
                min_market_cap: parseFloat(document.getElementById('market-cap-input').value),
                enable_market_cap: document.getElementById('enable-market-cap').checked,
                min_volume: parseFloat(document.getElementById('min-volume-input').value),
                gap_up_only: document.getElementById('gap-up-only').checked,
            };

            try {
                const res = await fetch('/api/strong', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'æœªçŸ¥éŒ¯èª¤');
                displayStrongStocks(data);
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error-message" style="display:block">âŒ éŒ¯èª¤ï¼š${err.message}</div>`;
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        function displayStrongStocks(data) {
            const div = document.getElementById('strong-stocks-results');

            if (!data.stocks || data.stocks.length === 0) {
                div.innerHTML = '<div class="no-results">ğŸ˜• ä»Šæ—¥æ²’æœ‰åŒæ™‚ç¬¦åˆæ‰€æœ‰æ¢ä»¶çš„å¼·å‹¢è‚¡</div>';
                return;
            }

            let html = `<p style="color:#555; font-size:0.88em; margin-bottom:12px;">
                    å…±ç¯©å‡º <strong>${data.stocks.length}</strong> æ”¯å¼·å‹¢è‚¡ï¼ˆä¾ <strong>å¼·å‹¢å¤©æ•¸</strong> æ’åºï¼Œè¶Šå¤šè¶Šå‰é¢ï¼‰
            </p>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em; background:white;">
                <thead>
                    <tr style="background:#e8eaf6; color:#1a237e;">
                        <th style="padding:10px 8px; text-align:left;">ä»£ç¢¼</th>
                        <th style="padding:10px 8px; text-align:left;">åç¨±</th>
                        <th style="padding:10px 8px; text-align:right;">å¼·å‹¢å¤©æ•¸</th>
                        <th style="padding:10px 8px; text-align:right;">è‚¡åƒ¹</th>
                        <th style="padding:10px 8px; text-align:right;">æ¼²è·Œå¹…</th>
                        <th style="padding:10px 8px; text-align:right;">æˆäº¤é‡(å¼µ)</th>
                        <th style="padding:10px 8px; text-align:left;">å¸‚å ´</th>
                        <th style="padding:10px 8px; text-align:left;">è©³ç´°èªªæ˜</th>
                    </tr>
                </thead>
                <tbody>`;

            data.stocks.forEach((s, i) => {
                const bg = i % 2 === 0 ? '#fff' : '#f9f9ff';
                const chg = parseFloat(s.change_pct);
                const chgColor = chg >= 0 ? '#c62828' : '#00695c';
                const chgText = (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
                const vol = Math.round(s.volume / 1000).toLocaleString();
                const mkt = s.market === 'LISTED' ? 'ä¸Šå¸‚' : 'ä¸Šæ«ƒ';
                const tags = s.reasons.map(r =>
                    `<span style="display:inline-block;background:#e8eaf6;color:#1a237e; padding:2px 8px;border-radius:10px;font-size:0.8em;margin:1px;">${r}</span>`
                ).join('');

                html += `<tr style="background:${bg}; border-bottom:1px solid #eee;">
                    <td style="padding:9px 8px; font-weight:bold; color:#1565c0;">${s.code}</td>
                    <td style="padding:9px 8px;">${s.name}</td>
                    <td style="padding:9px 8px; text-align:right; font-weight:bold; color:#d81b60; font-size:1.1em;">${s.score} å¤©</td>
                    <td style="padding:9px 8px; text-align:right;">${s.price}</td>
                    <td style="padding:9px 8px; text-align:right; font-weight:bold; color:${chgColor};">${chgText}</td>
                    <td style="padding:9px 8px; text-align:right;">${vol}</td>
                    <td style="padding:9px 8px;">${mkt}</td>
                    <td style="padding:9px 8px;">${tags}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            div.innerHTML = html;
        }

        // Initialize with default data
        window.addEventListener('load', () => {
            // Optional: Auto-load TAIEX on start
            document.getElementById('tab-navigation').style.display = 'flex';

            // Auto-load data on startup
            console.log("Auto-loading stock data...");
            filterStocks();
        });

        // æ‰‹å‹•æ›´æ–°å¤§ç›¤èˆ‡åŒæ­¥é‚è¼¯
        async function refreshIndices(event) { // Added 'event' parameter
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'â³ æ›´æ–°ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/refresh_indices');
                const data = await response.json();
                if (data.success) {
                    const idxPanel = document.getElementById('indices-panel');
                    idxPanel.style.display = 'flex';

                    document.getElementById('taiex-value').innerText = data.taiex.value.toLocaleString();
                    const taiexChg = document.getElementById('taiex-change');
                    taiexChg.innerText = `${data.taiex.change_pct}%`;
                    taiexChg.className = 'index-change ' + (data.taiex.change_pct >= 0 ? 'up' : 'down');

                    document.getElementById('otc-value').innerText = data.otc.value.toLocaleString();
                    const otcChg = document.getElementById('otc-change');
                    otcChg.innerText = `${data.otc.change_pct}%`;
                    otcChg.className = 'index-change ' + (data.otc.change_pct >= 0 ? 'up' : 'down');

                    alert('âœ… æŒ‡æ•¸å·²æ›´æ–°ï¼æ•¸æ“šæ™‚é–“ï¼š' + data.timestamp);
                }
            } catch (e) {
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
    <script src="{{ url_for('static', filename='search_charts.js') }}"></script>
</body>

</html>